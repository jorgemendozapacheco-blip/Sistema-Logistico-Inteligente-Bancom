{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block body %}
<style>
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        pointer-events: none;
        z-index: 0;
    }

    .card-transparent {
        background-color: rgba(255, 255, 255, 0.9);
    }

    .kpi-value {
        font-size: 1.75rem;
        font-weight: 500;
    }

    .kpi-label {
        font-size: 0.9rem;
        color: #666;
    }

    .chart-container {
        position: relative;
        width: 100%;
        height: 180px;
    }
</style>

<div class="container py-4 position-relative" style="z-index:1;">
    <h1 class="display-5 text-white mb-4">Dashboard</h1>

    <!-- 1) KPIs -->
    <div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 text-center py-3">
                <div class="kpi-value text-primary">{{ items_count }}</div>
                <div class="kpi-label">Total de Activos</div>
            </div>
        </div>
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 text-center py-3">
                <div class="kpi-value text-success">{{ nombres|length }}</div>
                <div class="kpi-label">Tipos de Activos</div>
            </div>
        </div>
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 text-center py-3">
                <div class="kpi-value text-warning">{{ total_localidades }}</div>
                <div class="kpi-label">Total de Agencias</div>
            </div>
        </div>
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 text-center py-3">
                <div class="kpi-value text-info">{{ total_pedidos_reservados }}</div>
                <div class="kpi-label">Pedidos</div>
            </div>
        </div>
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 text-center py-3">
                <div class="kpi-value text-success">{{ total_pedidos_aplicados }}</div>
                <div class="kpi-label">Pedidos Realizados</div>
            </div>
        </div>


    </div>

    <!-- 2) OTD: Pedidos a tiempo -->
    <div class="row row-cols-1 row-cols-md-1 g-4 mb-4">
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 h-100">
                <div class="card-header bg-white border-bottom-0 py-2">
                    <strong>Pedidos Entregados a Tiempo (OTD)</strong>
                </div>
                <div class="card-body p-3">
                    <div class="row align-items-center">
                        <!-- GRÁFICO DONUT -->
                        <div class="col-12 col-md-6 mb-2 mb-md-0 text-center">
                            <div style="width:200px; margin:auto;">
                                <canvas id="graficoPedidosTiempo" width="200" height="200"></canvas>
                            </div>
                            <div class="mt-2">
                                <span id="otdPorcentaje" class="fw-bold text-success" style="font-size:1.5rem"></span>
                            </div>
                        </div>
                        <!-- KPI Y DETALLES -->
                        <div class="col-12 col-md-6">
                            <ul class="list-group list-group-flush">
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>Pedidos a tiempo</span>
                                    <span class="fw-bold text-success" id="otdATiempo">-</span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>Pedidos fuera de tiempo</span>
                                    <span class="fw-bold text-danger" id="otdFueraTiempo">-</span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>Lima OTD</span>
                                    <span class="badge bg-primary" id="otdLima">-</span>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>Provincia OTD</span>
                                    <span class="badge bg-warning text-dark" id="otdProvincia">-</span>
                                </li>
                                <li class="list-group-item px-0 pt-2 pb-0 small text-muted">
                                    Entregado ≤ 4 días (Lima), ≤ 7 días (Provincia)
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3) Charts -->
    <div class="row row-cols-1 row-cols-md-3 g-4">
        <!-- Localidad vs Producto -->
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 h-100">
                <div class="card-header bg-white border-bottom-0 py-2">
                    <strong>Localidad vs Producto</strong>
                </div>
                <div class="card-body p-3">
                    <div class="row gx-2 gy-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Localidad</label>
                            <select id="locSelect" class="form-select form-select-sm">
                                <option value="">-- Todas --</option>
                                {% for loc in localidades %}
                                <option value="{{ loc.value }}">{{ loc.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Producto</label>
                            <select id="prodSelect" class="form-select form-select-sm">
                                <option value="">-- Todos --</option>
                                {% for p in nombres %}<option>{{ p }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="chart-container mx-auto">
                        <canvas id="locProdDonut"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Ítems por Producto -->
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 h-100">
                <div class="card-header bg-white border-bottom-0 py-2">
                    <strong>Ítems por Producto</strong>
                </div>
                <div class="card-body p-3">
                    <label class="form-label small">Filtrar Producto</label>
                    <select id="barProdSelect" class="form-select form-select-sm mb-3">
                        <option value="">-- Todos --</option>
                        {% for p in nombres %}<option>{{ p }}</option>{% endfor %}
                    </select>
                    <div class="chart-container mx-auto">
                        <canvas id="prodBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Estado vs Producto -->
        <div class="col">
            <div class="card card-transparent shadow-sm rounded-3 h-100">
                <div class="card-header bg-white border-bottom-0 py-2">
                    <strong>Estado vs Producto</strong>
                </div>
                <div class="card-body p-3">
                    <div class="row gx-2 gy-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Estado</label>
                            <select id="stateSelect" class="form-select form-select-sm">
                                <option value="">-- Todos --</option>
                                {% for e in estados %}<option>{{ e }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Producto</label>
                            <select id="prodStateSelect" class="form-select form-select-sm">
                                <option value="">-- Todos --</option>
                                {% for p in nombres %}<option>{{ p }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="chart-container mx-auto">
                        <canvas id="stateProdDonut"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Configuración común para Doughnuts
        const makeDonut = (ctx) => new Chart(ctx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderColor: '#fff', borderWidth: 1 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 15 } } }
            }
        });

        const locChart = makeDonut(document.getElementById('locProdDonut').getContext('2d'));
        const barChart = new Chart(
            document.getElementById('prodBarChart').getContext('2d'), {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Cant.', data: [], backgroundColor: [], borderColor: '#fff', borderWidth: 1 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { ticks: { autoSkip: false, maxRotation: 45 } }, y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
        const stateChart = makeDonut(document.getElementById('stateProdDonut').getContext('2d'));

        function updateLoc() {
            const loc = encodeURIComponent(document.getElementById('locSelect').value);
            const prod = encodeURIComponent(document.getElementById('prodSelect').value);
            fetch(`{% url 'academico:loc_prod_data' %}?loc=${loc}&prod=${prod}`)
                .then(response => response.json())
                .then(data => {
                    locChart.data.labels = data.labels;
                    locChart.data.datasets[0].data = data.counts;
                    locChart.data.datasets[0].backgroundColor =
                        data.counts.map((_, i) => `hsl(${i * 60},70%,60%)`);
                    locChart.update();
                });
        }

        function updateBar() {
            const prod = encodeURIComponent(document.getElementById('barProdSelect').value);
            fetch(`{% url 'academico:prod_data' %}?prod=${prod}`)
                .then(r => r.json()).then(d => {
                    barChart.data.labels = d.labels;
                    barChart.data.datasets[0].data = d.counts;
                    barChart.data.datasets[0].backgroundColor =
                        d.counts.map((_, i) => `hsl(${i * 60},70%,60%)`);
                    barChart.update();
                });
        }

        function updateState() {
            const estado = encodeURIComponent(document.getElementById('stateSelect').value);
            const producto = encodeURIComponent(document.getElementById('prodStateSelect').value);
            fetch(`{% url 'academico:estado_prod_donut_data' %}?estado=${estado}&producto=${producto}`)
                .then(r => r.json()).then(d => {
                    stateChart.data.labels = d.labels;
                    stateChart.data.datasets[0].data = d.counts;
                    stateChart.data.datasets[0].backgroundColor =
                        d.counts.map((_, i) => `hsl(${i * 60},70%,60%)`);
                    stateChart.update();
                });
        }

        ['locSelect', 'prodSelect'].forEach(id => document.getElementById(id).onchange = updateLoc);
        ['barProdSelect'].forEach(id => document.getElementById(id).onchange = updateBar);
        ['stateSelect', 'prodStateSelect'].forEach(id => document.getElementById(id).onchange = updateState);

        updateLoc();
        updateBar();
        updateState();

        // -------- OTD: Pedidos Entregados a Tiempo ---------
        fetch("{% url 'academico:pedidos_a_tiempo_data' %}")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('graficoPedidosTiempo').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: [
                                'hsl(140,70%,50%)', // verde
                                'hsl(0,70%,60%)'   // rojo claro
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '65%',
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 12 } } },
                            title: { display: false }
                        }
                    }
                });
                // KPI's OTD
                document.getElementById('otdPorcentaje').textContent = `${data.porcentaje}% a tiempo`;
                document.getElementById('otdATiempo').textContent = data.a_tiempo;
                document.getElementById('otdFueraTiempo').textContent = data.fuera_tiempo;
                document.getElementById('otdLima').textContent = data.otd_lima + "%";
                document.getElementById('otdProvincia').textContent = data.otd_provincia + "%";
            });
    });
</script>
{% endblock %}